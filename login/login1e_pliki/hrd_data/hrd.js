"use strict";var __extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(b,a){b.__proto__=a}||function(c,a){for(var b in a)if(a.hasOwnProperty(b))c[b]=a[b]};return function(c,b){a(c,b);function d(){this.constructor=c}c.prototype=b===null?Object.create(b):(d.prototype=b.prototype,new d)}}(),HostInterface;(function(a){var d="O15WindowsClientHostInterface",c="PostMessageHostInterface",b="StopUrlHostInterface";a[a[b]=0]=b;a[a[c]=1]=c;a[a[d]=2]=d})(HostInterface||(HostInterface={}));var HrdMode;(function(a){var h="OTPCodeFlow",g="SplitterView",f="OpenFromTenant",e="Discovery",d="AcceptInvitation",c="SwitchAccount",b="OpenFromWeb",n="AddService",m="FirstRun",l="LicensingAuthZFailure",k="Disclosure",j="LicensingNotify",i="Licensing";a[a["Generic"]=0]="Generic";a[a[i]=1]=i;a[a[j]=2]=j;a[a[k]=3]=k;a[a[l]=4]=l;a[a[m]=5]=m;a[a[n]=6]=n;a[a[b]=7]=b;a[a[c]=8]=c;a[a[d]=9]=d;a[a[e]=10]=e;a[a[f]=11]=f;a[a[g]=12]=g;a[a["IRMFlow"]=13]="IRMFlow";a[a[h]=14]=h})(HrdMode||(HrdMode={}));var HrdUlsHost=function(b){__extends(a,b);function a(d){var a=this,e=5*1024,c=3e4,f=new Diag.UlsUploadConfiguration(e,null,c);a=b.call(this,d,"/odc/"+Diag.UploadingUlsHost.defaultRemoteUlsUrl,f)||this;return a}return a}(Diag.UploadingUlsHost),Hrd=function(){var i="&emailAddress=",f="<span/>",g="<a/>",e="?",h="undefined",d=true,c=false,a=null;function b(f,g){var e=this;e.config=f;e.MSASignInPolicyValue=1;e.OrgIdSignInPolicyValue=2;e.msAccountIdpParamValue="live";e.orgIdIdpParamValue="org";e.adalIdpParamValue="adal";b.initLogging(f.correlationId);b.self=e;e.config=f;e.config.text=g;e.context=ko.observable(a);e.email=ko.observable("");e.error=ko.observable(a);e.isRequestPending=ko.observable(c);e.isRightToLeft=ko.observable(c);e.focus=ko.observable(c);e.showCreateAccount=ko.observable(d);e.showSplitter=ko.observable(c);e.showEnterProductKey=ko.observable(c);e.init()}b.postMessage=function(a){parent.postMessage(JSON.stringify(a),"*")};b.prototype.cancelDialog=function(){Diag.ULS.sendTraceTag(23171342,b.featureCategory,Diag.ULSTraceLevel.info,"Dialog canceled.");switch(this.config.params.hostInterface){case HostInterface.O15WindowsClientHostInterface:var a=window.external;a.CancelDialog();break;case HostInterface.StopUrlHostInterface:var c=decodeURIComponent(this.config.params.path+"?op=CancelDialog");window.location.href=c;break;case HostInterface.PostMessageHostInterface:b.postMessage({op:"CancelDialog"})}};b.disposeLogging=function(a){a.flushForAppClose();a.dispose()};b.errorLogger=function(e,d,a){var c="Error ("+e+") encountered in ("+d+") at line number ("+a+")";Diag.ULS.sendTraceTag(23171340,b.featureCategory,Diag.ULSTraceLevel.error,"{0}",c)};b.prototype.getContextInformation=function(){try{var b=window.external;if(typeof b.GetContextInfo!=h)return b.GetContextInfo()}catch(c){window.console&&console.log(c.message)}return a};b.initLogging=function(c){var a=new HrdUlsHost(c);Diag.ULS.setUlsHost(a);window.onerror=b.errorLogger;window.onbeforeunload=function(){return b.disposeLogging(a)}};b.prototype.init=function(){var a=this,b=a;if(a.config.params.email&&a.config.params.sp){a.config.params.sp===a.MSASignInPolicyValue&&a.msAccountSignIn();a.config.params.sp===a.OrgIdSignInPolicyValue&&a.orgIdSignIn()}if(a.config.params.idp)if(a.config.params.idp===a.msAccountIdpParamValue){a.config.text.emailPlaceHolder=a.config.text.emailPlaceHolderPersonal;a.config.text.emailPlaceHolderAria=a.config.text.emailPlaceHolderPersonalAria}else{a.showCreateAccount(c);a.config.text.emailPlaceHolder=a.config.text.emailPlaceHolderWork;a.config.text.emailPlaceHolderAria=a.config.text.emailPlaceHolderWorkAria}if(a.config.params.email){a.email(a.config.params.email);a.config.params.autosubmit&&a.submit()}if(!String.prototype.trim)String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")};a.isRightToLeft(a.config.params.dir==="rtl");a.showSplitter(a.config.params.hm===HrdMode.SplitterView);a.showEnterProductKey(a.config.params.hm===HrdMode.Licensing);var d=navigator.userAgent.indexOf("MSIE ")>0||!!navigator.userAgent.match(/Trident.*rv\:11\./);a.showPlaceholder=ko.pureComputed(function(){return d&&!b.email()});$(a.ready)};b.prototype.launchUrl=function(a){switch(this.config.params.hostInterface){case HostInterface.O15WindowsClientHostInterface:var d=window.external;d.LaunchUrl(a,c);break;case HostInterface.StopUrlHostInterface:window.location.href=decodeURIComponent(this.config.params.path+"?op=LaunchUrl&url=")+encodeURIComponent(a);break;case HostInterface.PostMessageHostInterface:b.postMessage({op:"LaunchUrl",url:a})}};b.prototype.msAccountSignUp=function(){this.showNext(0)};b.prototype.msAccountSignIn=function(){this.showNext(1)};b.prototype.orgIdSignIn=function(){this.showNext(2)};b.prototype.thirdPartySignIn=function(){this.showNext(4)};b.prototype.oneTimePassCode=function(){this.showNext(5)};b.prototype.ready=function(){var a="click";$("html").attr("dir",b.self.config.params.dir).attr("lang",b.self.config.params.culture);ko.applyBindings(b.self);$(document).keydown(b.keyPressHandler);$(document).on(a,"a[data-url]",function(a){a.preventDefault();b.self.launchUrl($(this).data("url"))});$(document).on(a,"a[data-signup]",function(a){a.preventDefault();b.self.msAccountSignUp()});$(document).on(a,"a[otpcode-signup]",function(a){a.preventDefault();b.self.oneTimePassCode()});b.self.setDescriptionForContext();b.postMessage({op:"OnReady",calcHeightPx:($(".inner").outerHeight()+60).toString()});$("main").show();b.self.focus(b.self.config.params.focus)};b.prototype.getUrlQSParameters=function(c){var a={},b=c.split(e);b.length>1&&b[1].split("&").forEach(function(e){var c=e.split("="),d=c[0],b=c[1];b=b&&decodeURIComponent(b);(a[d]=a[d]||[]).push(b)});return a};b.prototype.getTruncatedTitle=function(a){var b=64;if(a.length>b){a=a.substring(0,b-2);a+=".."}return a};b.prototype.getTitle=function(g,f){if(f!=a){f=decodeURIComponent(f);return this.getTruncatedTitle(f)}var d=g.split("/");if(d.length==0||d[d.length-1].length==0){Diag.ULS.sendTraceTag(38123155,b.featureCategory,Diag.ULSTraceLevel.warning,"Invalid URL");return ""}var c=d[d.length-1].split(e)[0],h=this.getUrlQSParameters(g);if("file" in h)c=h["file"];c=decodeURIComponent(c);var i=/^.*\.aspx$/;if(i.test(c))c=g;return this.getTruncatedTitle(c)};b.prototype.setDescriptionForContext=function(){var d=this;d.context(a);if(d.config.params.hm!==HrdMode.OpenFromWeb)return;var j=d.getContextInformation(),c=$.parseJSON(j);if((c||a)&&(c.url||a)&&(c.title||a||(c.friendlyUrl||a))){var k=c.knownUrl?d.config.text.openFromWebWithKnownUrl:d.config.text.openFromWebWithUnknownUrl,h=b.validateUrlScheme(c.url),e=$(h?g:f);e.text(d.getTitle(c.friendlyUrl,c.title));if(h){(c.friendlyUrl||a)&&e.attr({title:c.friendlyUrl});e.attr({href:"#","data-url":c.url}).addClass("description")}var i=$(f).html(k.replace("{0}",f));$("span",i).replaceWith(e);d.context(i[0].outerHTML)}else d.context(d.config.text.openFromWeb)};b.prototype.submit=function(){var e=this;e.federationProvider=a;e.idp=a;e.error(a);e.isRequestPending(c);var f=e.validateInput(e.email());if(f===a){e.error(e.config.text.accountLookupErrors);e.focus(d);return}e.isRequestPending(d);Diag.ULS.sendTraceTag(23171341,b.featureCategory,Diag.ULSTraceLevel.info,"Next clicked.");if(e.isEmail(f))e.getFederationProvider(f);else e.getIdp(f)};b.prototype.showPKD=function(){Diag.ULS.sendTraceTag(23171343,b.featureCategory,Diag.ULSTraceLevel.info,"PKD invoked.");switch(this.config.params.hostInterface){case HostInterface.O15WindowsClientHostInterface:var a=window.external;a.ShowPKD();break;case HostInterface.StopUrlHostInterface:window.location.href=decodeURIComponent(this.config.params.path+"?op=ShowPKD");break;case HostInterface.PostMessageHostInterface:b.postMessage({op:"ShowPKD"})}};b.keyPressHandler=function(a){if(a.which===27){b.self.cancelDialog();return}if(b.self.config.params.hm===HrdMode.SplitterView){if(a.which===13||a.which===32){var c=$(a.target).data("idp");switch(c){case b.self.msAccountIdpParamValue:a.preventDefault();b.self.msAccountSignIn();return;case b.self.orgIdIdpParamValue:a.preventDefault();b.self.orgIdSignIn();return}}}else if(a.which===13&&b.self.focus()){a.preventDefault();b.self.submit();return}};b.endsWith=function(b,c,a){if(typeof a!=="number"||!isFinite(a)||Math.floor(a)!==a||a>b.length)a=b.length;a-=c.length;var d=b.lastIndexOf(c,a);return d!==-1&&d===a};b.validateUrlScheme=function(a){var b=/^(https?|ftp|file|mailto):\/\//i;return typeof a==="string"&&a.length!=0&&b.test(a)};b.prototype.getDomainWithoutTld=function(b){if(!this.isEmail(b))return a;var c=b?b.indexOf("@"):-1;return b.substring(c+1,b.indexOf(".",c+1))};b.prototype.getFederationProvider=function(j){var g=this,f=g;if(!j)return;var k=j.indexOf("@");if(k===-1)return;var l=j.substring(k+1),m=g.config.services.getFederationProviderUrl+(g.config.services.getFederationProviderUrl.indexOf(e)===-1?e:"&")+"domain="+encodeURIComponent(l),i={};i["X-CorrelationId"]=g.config.correlationId;if(g.config.officeApplication)i["X-Office-Application"]=g.config.officeApplication;if(g.config.officePlatform)i["X-Office-Platform"]=g.config.officePlatform;if(g.config.oneAuthAppId)i["X-OneAuth-AppId"]=g.config.oneAuthAppId;if(g.config.oneAuthAppName)i["X-OneAuth-AppName"]=g.config.oneAuthAppName;if(g.config.oneAuthVersion)i["X-OneAuth-Version"]=g.config.oneAuthVersion;$.ajax({url:m,cache:c,timeout:g.config.services.getFederationProviderTimeOut,headers:i}).always(function(){f.isRequestPending(c)}).done(function(e,m,i){var k="AuthorizationService",l="TokenService";f.authorizationService=i.getResponseHeader(k);f.tokenService=i.getResponseHeader(l);if(typeof e===h||!e)return;var g=e.environment?d:c;if(!g)e={environment:e};if(e.environment==="Global"&&!e.configProviderName){f.federationProvider=g?ko.toJSON(e):a;f.getIdp(j)}else if(e.environment==="Error"){Diag.ULS.sendTraceTag(23212251,b.featureCategory,Diag.ULSTraceLevel.error,"getFederationProvider issue. Status {0}",m);f.showError(a,a)}else if(f.config.params.fpEnabled){if(f.config.params.idp===f.msAccountIdpParamValue){f.error(f.config.text.guardrailMessage);return}f.federationProvider=g?ko.toJSON(e):e.environment;f.orgIdSignIn()}else f.error(f.config.text.updateRequired)}).fail(function(b,a){f.showError(b,a)})};b.prototype.getIdp=function(k){var j=this,h=j,l=j.config.services.getIdpUrl+(j.config.services.getIdpUrl.indexOf(e)===-1?e:"&")+"hm="+encodeURIComponent(j.config.params.hm.toString())+i+encodeURIComponent(k),m=j.config.params.idp===j.msAccountIdpParamValue&&j.config.params.app===107;if(j.config.params.idp&&!m)l+="&idp="+encodeURIComponent(j.config.params.idp);if(j.config.params.minimalEmailValidation===d)l+="&minimalEmailValidation=true";$.ajax({url:l,cache:c,timeout:j.config.services.getIdpTimeout,headers:{"X-CorrelationId":j.config.correlationId}}).always(function(){h.isRequestPending(c)}).done(function(e){var i="outerHTML";if(!e)return;var n=e.account?d:c;if(!n)e={account:e};if(e.account.indexOf(",")>=0)e.account=e.account.split(",")[0];switch(e.account){case "MSAccount":case "MSAccountNonEmail":h.msAccountSignIn();break;case "OrgId":if(m){h.error(h.config.text.msaOnly);h.focus(d)}else h.orgIdSignIn();break;case "Neither":if(h.config.params.hm===HrdMode.OTPCodeFlow){var j=$(f).text(h.config.text.oneTimeCodePrompt).prop(i),p=$(g).text(h.config.text.oneTimeCodeLink).attr({href:"#","otpcode-signup":"otpcode"}).prop(i);j=j.replace("{0}",p);h.error(j)}else if(h.config.params.hm===HrdMode.IRMFlow&&b.endsWith(k,"@gmail.com"))h.thirdPartySignIn();else if(h.config.params.accelerated&&!h.isFirstPartyMsaDomain(k))h.msAccountSignUp();else{var l=h.showCreateAccount()&&h.config.params.hm!=HrdMode.Licensing&&h.config.params.hm!=HrdMode.LicensingNotify&&h.config.params.hm!=HrdMode.OpenFromWeb&&h.config.params.hm!=HrdMode.OpenFromTenant&&h.config.params.hm!=HrdMode.IRMFlow;if(l){var o=$(f).text(h.config.text.accountNotFoundSignUp+" ").append($(g).text(h.config.text.signUpLink).attr({href:"#","data-signup":"msa"}));h.error(o.html())}else if(h.config.params.idp===h.adalIdpParamValue||h.config.params.idp===h.orgIdIdpParamValue)h.error(h.config.text.accountNotFoundOrgId);else h.error(h.config.text.accountNotFound);h.focus(d)}break;case "Both":if(h.config.params.idp===h.msAccountIdpParamValue)h.msAccountSignIn();else if(h.config.params.idp===h.orgIdIdpParamValue)h.orgIdSignIn();else h.showSplitter(d);break;case "Guardrail":if(h.config.params.idp===h.adalIdpParamValue||h.config.params.idp===h.orgIdIdpParamValue)h.error(h.config.text.accountNotFoundOrgId);else h.error(h.config.text.guardrailMessage);h.focus(d);break;case "Error":if(h.config.params.minimalEmailValidation===d){h.error(h.config.text.accountNotFound);h.focus(d);break}Diag.ULS.sendTraceTag(23212252,b.featureCategory,Diag.ULSTraceLevel.error,"getIdp Error.");h.showError(a,a);break;case "Throttled":Diag.ULS.sendTraceTag(23212253,b.featureCategory,Diag.ULSTraceLevel.error,"getIdp Throttled.");h.showError(a,a);break;case "HIPValidationFailed":Diag.ULS.sendTraceTag(23212254,b.featureCategory,Diag.ULSTraceLevel.error,"getIdp HIPValidationFailed.");h.showError(a,a);break;default:Diag.ULS.sendTraceTag(23212255,b.featureCategory,Diag.ULSTraceLevel.error,"getIdp error: {0}.",e);h.showError(a,a)}}).fail(function(b,a){h.showError(b,a)})};b.prototype.isEmail=function(a){var b=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return a.length>2&&b.test(a)};b.prototype.isFirstPartyMsaDomain=function(e){var b=this.getDomainWithoutTld(e);if(b==a)return c;switch(b.toLowerCase()){case "live":case "live-int":case "hotmail":case "hotmail-int":case "outlook":case "outlook-int":return d;default:return c}};b.prototype.showError=function(e){var a=this;a.isRequestPending(c);if(e&&(e.status===404||e.status===502)){a.error(a.config.text.networkError);Diag.ULS.sendTraceTag(34628224,b.featureCategory,Diag.ULSTraceLevel.error,"Network issue. Status code {0}",e.status)}else a.showSplitter(d)};b.prototype.showNext=function(e){var c=this;c.isRequestPending(d);switch(c.config.params.hostInterface){case HostInterface.O15WindowsClientHostInterface:var g=window.external;if(c.email())if(c.federationProvider||a)g.ShowNext(e,c.email(),c.federationProvider);else g.ShowNext(e,c.email());else g.ShowNext(e);break;case HostInterface.StopUrlHostInterface:var h=decodeURIComponent(c.config.params.path+"?op=ShowNext&nextScreen="+e);if(c.email())h+=i+encodeURIComponent(c.email());if(c.federationProvider||a)h+="&federationProvider="+encodeURIComponent(c.federationProvider);window.location.href=h;break;case HostInterface.PostMessageHostInterface:var f={op:"ShowNext",nextScreen:e.toString()};if(c.email())f.emailAddress=c.email();if(c.federationProvider||a)f.federationProvider=c.federationProvider;if(c.authorizationService||a)f.authorizationService=c.authorizationService;if(c.tokenService||a)f.tokenService=c.tokenService;b.postMessage(f)}};b.prototype.validateInput=function(c){if(!c)return a;c=c.trim();if(c.length<1)return a;var b=decodeURIComponent(c);if(!b||b.length<1)return a;if(b.indexOf("@")!==-1){if(b.indexOf(",")!==-1)return a;var d=b.replace(/\s+(?=(?:(?:[^"]*"){2})*[^"]*"[^"]*$)/gm,"a");if(d===a||d.indexOf(" ")>=0)return a}if(b.indexOf("<")!==-1||b.indexOf(">")!==-1)return a;return b};b.featureCategory=1800;b.self=a;return b}()